{% for key,st in stores %}
app.service('{{ key }}', function ($http,$q,$timeout{% for child in st.childrenelements %},{{ child.identifier }}Store{% endfor %}) {
    var {{ st.identifier }}Store = [],
        currentPage = 1,
        pageLoaded = 0,
        total = 0,
        pageLength = 15,
        filters = '',
        timer = 0,
        query = '/{{ st.module }}/{{ st.objecttype }}',
        busy = false;
    return {
        getOneData: getOneData,
        getData: getData,
        getNewData: getNewData,
        saveData: saveData,
        getTotal: getTotal,
        export: exportData,
        setPage: setPage,
        setFilters: setFilters,
        getFilters: getFilters,
        getPageLength: getPageLength,
        setPageLength: setPageLength,
        currentPage: currentPage,
        itemsPerPage: pageLength,
        getDataFilter: getDataFilter,
        refresh: refresh,
        filter: filters,
        resetQuery: resetQuery,
        setQuery: setQuery,
        data:{{ st.identifier }}Store
    };
    function resetQuery(q) {
        pageLoaded = 0;
        query = '/{{ st.module }}/{{ st.objecttype }}';
    }
    function setQuery(q) {
        pageLoaded = 0;
        query = q;
    }
    function setPageLength(pl) {
        pageLength = pl;
    }
    function getPageLength() {
        return pageLength;
    }
    function getTotal() {
        return total;
    }
    function purgeStore(){
        /*for (var i in {{ st.identifier }}Store){
            {{ st.identifier }}Store.pop();
        }*/
        {{ st.identifier }}Store.splice(0,{{ st.identifier }}Store.length);
    }
    /**
    * Définition de la page en cours
    */
    function setPage(page){
        getData(page);
    }
    /**
    * Définition du filtre
    **/
    function refresh(){
        pageLoaded--;
        getData(currentPage);
    }
    /**
    * Définition du filtre
    **/
    function setFilters(filter,blur = false){
        if (filter==filters) return;
        filters = (blur?'~':'')+filter;
        //on recharge le store
        $timeout.cancel(timer);
        timer=$timeout(function (){
            pageLoaded=0;
            getData(1);
        }, 300);
    }
    /**
    * Récupération du filtre en cours
    **/
    function getFilters(){
        return filters;
    }
    /**
    * Test if this id already exists
    */
    function alreadyExists(id){
        for (var i in {{ st.identifier }}Store){
            if ({{ st.identifier }}Store[i].Id==id){
                return true;
            }
        }
        return false;
    }
    /**
    * exportData
    * export des données en fichier csv
    */
    function exportData(){
        window.open(query+'/Export.csv','_blank');
        console.log('store > {{ key }} > export '+query);
    }
    /**
    * SaveData
    * Envoie des données vers le serveur et gestion des erreurs
    */
    function saveData(obj){
        return $q(function(resolve, reject) {
            var q = (obj.id > 0) ? '/{{ st.module }}/{{ st.objecttype }}/'+obj.id+'/Save.json' :'/{{ st.module }}/{{ st.objecttype }}/Save.json'
            $http.post(q,obj)
                .success(function(data) {
                    console.log('store > {{ key }} > save success '+obj.id, data);
                    resolve(data);
            });
        });
    }
    /**
    * Return new data with default values
    * Return Promise
    */
    function getNewData() {
        console.log('new data {{ st.newData }}');
        return {{ st.newData | raw }};
    }
    /**
    * Look for specific id data into the store
    * Return Promise
    */
    function getOneData(id,full = true) {
        return $q(function(resolve, reject) {
            console.log('store > {{ st.identifier }} > getOneData '+id,id);
            /*for (var i in {{ st.identifier }}Store){
                if ({{ st.identifier }}Store[i].id==id){
                    var idStore = i;
                    loadChildren({{ st.identifier }}Store[i]).then(function (obj){
                        {{ st.identifier }}Store[idStore] = obj;
                        resolve(obj);
                    });
                    continue;
                }
            }*/
            //si store pas chargé ou introuvable
            $http.get('/{{ st.module }}/{{ st.objecttype }}/'+id+'/getOneData.json')
                .success(function(data) {
                    console.log('store > {{ key }} > load success '+id, data);
                    //on charge les enfants uniquement si param full
                    if (full)
                        loadChildren(data).then(function (obj){
                            resolve(obj);
                        });
                    else resolve(data);
            });
        });
    }
    /**
    * Get data for combo component
    */
    function getDataFilter (filter) {
        setFilters('~'+filter);
        return getData(1);
    }
    /**
    * Load more data base on page
    */
    function getData(page) {
        if (page<1) page=1;
        return $q(function(resolve, reject) {
            if (busy) {
                reject('already busy');
                return;
            }
            console.log('store > {{ key }} > getData '+page);
            if (!page) page = currentPage;
            else currentPage = page;
            if (page!=pageLoaded){
                busy=true;
                $http.get(
                    query+'/getData.json',
                    {
                        params: {
                            filters: filters,
                            offset: (page-1)*pageLength,
                            limit: pageLength
                        }
                    }).success(function(data) {
                        busy=false;
                        purgeStore();
                        pageLoaded = page;
                        total = data.total;
                        for (var i in data.data) {
                            if (!alreadyExists(data.data[i].id))
                                {{ st.identifier }}Store.push(data.data[i]);
                        }
                        //{{ st.identifier }}Store = data.data;
                        console.log('store > {{ key }} > loaded success ',{{ st.identifier }}Store);
                        resolve({{ st.identifier }}Store);
                });
            }else resolve({{ st.identifier }}Store);
    });
    }
    /**
    * Chargement des données enfants
    */
    function loadChildren(obj) {
        var num = {{ st.childrenelements | length }};
        return $q(function(resolve, reject) {
            {% for child in st.childrenelements %}
                {{ child.objectModule }}{{ child.objectName }}Store.setQuery('/{{ st.module }}/{{ st.objecttype }}/'+obj.id+'/{{ child.objectName }}');
                if (!obj.{{ child.objectName }}) {
                    obj.{{ child.objectName }} = {{ child.objectModule }}{{ child.objectName }}Store.data;
                    /*{{ child.objectModule }}{{ child.objectName }}Store.getData().then(function () {
                        num--;
                        if (num==0) resolve(obj);
                    });*/
                    num--;
                    if (num==0) resolve(obj);
                }else{
                    {{ child.objectModule }}{{ child.objectName }}Store.data = obj.{{ child.objectName }};
                    num--;
                    if (num==0) resolve(obj);
                }
            {% endfor %}
            if (num==0) resolve(obj);
        });
    }
});
{% endfor %}
