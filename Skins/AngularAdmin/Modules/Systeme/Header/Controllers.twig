{% for c in controllers %}
    {% if c.extends %}
        {{ include(template_from_string(module(c.extends))) }}
    {% endif %}

    {% if c.overload %}
    /**** OVERLOAD CONTROLLER  ****/
        {{ include(template_from_string(module(c.overload))) }}
    {% elseif not c.store %}
        app.controller('{{ c.name }}Ctrl', function() {});
    {% else %}
    /**** LIST CONTROLLER  ****/
    app.controller('{{ c.name }}Ctrl', function($controller,$injector,$location, $scope,$timeout, $rootScope,$http,{{ c.identifier }}Store{% for parent in c.parentelements %},{{ parent.objectModule }}{{ parent.objectName }}Store{% endfor %}{% for child in c.childrenelements %},{{ child.objectModule }}{{ child.objectName }}Store{% endfor %}) {
        //test du store
        $scope.{{ c.identifier }} = {
            data: {{ c.identifier }}Store.data.default,
            store: {{ c.identifier }}Store,
            filter: {{ c.identifier }}Store.getFilters('default',true).global,
            filterPanel: false,
            filters: (function(){
                var opts = {{ c.identifier }}Store.getFilters('default',true).options;
                var out = {};
                for (var o in opts){
                    out[opts[o].name] = opts[o];
                }
                return out;
            })(),
            filterQuery: {{ c.identifier }}Store.getQueryFilter('default'),
            currentPage: {{ c.identifier }}Store.currentPage.default,
            pageLength: {{ c.identifier }}Store.getPageLength(),
            itemsPerPage: {{ c.identifier }}Store.itemsPerPage,
            selected: {
                selectall: false
            }
        }

        //acces aux stores parents
        {% for parent in c.parentelements %}
            $scope.{{ parent.objectModule }}{{ parent.objectName }}Select = {
                data: {{ parent.objectModule }}{{ parent.objectName }}Store.data.parentselect,
                store: {{ parent.objectModule }}{{ parent.objectName }}Store,
                filter: {{ parent.objectModule }}{{ parent.objectName }}Store.getFilters('parentselect',true).global,
                filterPanel: false,
                filters: {{ parent.objectModule }}{{ parent.objectName }}Store.getFilters('parentselect',true).options,
                currentPage: {{ parent.objectModule }}{{ parent.objectName }}Store.currentPage.parentselect,
                itemsPerPage: {{ parent.objectModule }}{{ parent.objectName }}Store.itemsPerPage,
                selected: {
                    selectall: false
                }
            }
            //watcher recherche
            var {{ parent.objectModule }}{{ parent.objectName }}lasttimeout = false;
            $scope.$watch('{{ parent.objectModule }}{{ parent.objectName }}Select.filter', function() {
                //on lance la recherche depuis le store
                if ({{ parent.objectModule }}{{ parent.objectName }}lasttimeout){
                    $timeout.cancel({{ parent.objectModule }}{{ parent.objectName }}lasttimeout);
                    {{ parent.objectModule }}{{ parent.objectName }}lasttimeout = false;
                }
                {{ parent.objectModule }}{{ parent.objectName }}Store.setGlobalFilter($scope.{{ parent.objectModule }}{{ parent.objectName }}Select.filter,'parentselect');
                {{ parent.objectModule }}{{ parent.objectName }}lasttimeout = $timeout(function () {
                    {{ parent.objectModule }}{{ parent.objectName }}Store.getData(1,'parentselect');
                },200);
            });
            //watcher currentPage
            $scope.$watch('{{ parent.objectModule }}{{ parent.objectName }}Select.currentPage', function() {
                {{ parent.objectModule }}{{ parent.objectName }}Store.setPage($scope.{{ parent.objectModule }}{{ parent.objectName }}Select.currentPage,'parentselect');
            });

        {% endfor %}

        //acces aux stores enfants
        {% for child in c.childrenelements %}
            $scope.{{ child.objectModule }}{{ child.objectName }}Select = {
                data: {{ child.objectModule }}{{ child.objectName }}Store.data.select,
                store: {{ child.objectModule }}{{ child.objectName }}Store,
                filter: {{ child.objectModule }}{{ child.objectName }}Store.getFilters('select',true).global,
                filterPanel: false,
                filters: {{ child.objectModule }}{{ child.objectName }}Store.getFilters('select',true).options,
                currentPage: {{ child.objectModule }}{{ child.objectName }}Store.currentPage.select,
                itemsPerPage: {{ child.objectModule }}{{ child.objectName }}Store.itemsPerPage,
                selected: {
                    selectall: false
                }
            }
            //watcher recherche
            var {{ child.objectModule }}{{ child.objectName }}lasttimeout = false;
            $scope.$watch('{{ child.objectModule }}{{ child.objectName }}Select.filter', function() {
                //on lance la recherche depuis le store
                if ({{ child.objectModule }}{{ child.objectName }}lasttimeout){
                    $timeout.cancel({{ child.objectModule }}{{ child.objectName }}lasttimeout);
                    {{ child.objectModule }}{{ child.objectName }}lasttimeout = false;
                }
                {{ child.objectModule }}{{ child.objectName }}Store.setGlobalFilter($scope.{{ child.objectModule }}{{ child.objectName }}Select.filter,'select');
                {{ child.objectModule }}{{ child.objectName }}lasttimeout = $timeout(function () {
                    {{ child.objectModule }}{{ child.objectName }}Store.getData(1,'select');
                },200);
            });
            //watcher currentPage
            $scope.$watch('{{ child.objectModule }}{{ child.objectName }}Select.currentPage', function() {
                {{ child.objectModule }}{{ child.objectName }}Store.setPage($scope.{{ child.objectModule }}{{ child.objectName }}Select.currentPage,'select');
            });
        {% endfor %}

        //mass delete
        //sélection
        $scope.$watch('{{ c.identifier }}.selected.selectall', function() {
            if ($scope.{{ c.identifier }}.selected.selectall){
                var data = {{ c.identifier }}Store.data['default'];
                for (var i in data) {
                    $scope.{{ c.identifier }}.selected[data[i].id] = true;
                }
            }else{
            $scope.{{ c.identifier }}.selected = {};
            }
        });

        //call function
        $scope.{{ c.identifier }}callFunction = function (obj,name,title){
            console.log('callfunction ',obj.id,title);
            $('#modalfunction-{{ c.identifier }} .modal-dialog').spin();

            $scope.{{ c.identifier }}function = {
                title: title,
                loaded: false,
                name: name,
                url: '/{{ c.module }}/{{ c.objecttype }}/'+obj.id+'/'+name+'.htm?rand='+new Date().getTime()
            };

            {{ c.identifier }}Store.getOneData(obj.id,false).then(function (data) {
                $scope.modalObj = data;
                console.log('function '+title+' obj',$scope.modalObj);
                $('#modalfunction-{{ c.identifier }} .modal-dialog').spin(false);
            });

            $("#modalfunction-{{ c.identifier }}").modal();
        }

        //select Delete
        $scope.{{ c.identifier }}selectDelete = function () {
            //nettoyage de la selection
            var sel= [];
            for (var i in $scope.{{ c.identifier }}.selected){
                if ($scope.{{ c.identifier }}.selected[i]&&parseInt(i)>0)sel.push(i);
            }
            console.log('Suppression de la sélection ',sel);
            swal({
                    title: "Êtes vous sûr de vouloir supprimer les "+sel.length+" éléments ?",
                    text: "Cette suppression sera définitive. ",
                    type: "warning",
                    showCancelButton: true,
                    confirmButtonClass: "btn-danger",
                    cancelButtonText: "Annuler",
                    confirmButtonText: "Oui, supprimer !",
                    closeOnConfirm: true
                },
                function(){
                    $http.post('/{{ c.module }}/{{ c.objecttype }}/massDelete.json',sel)
                    .success(function(data) {
                        console.log('store > {{ c.module }}/{{ c.objecttype }} > deleted ', data);
                        {{ c.identifier }}Store.refresh('default');
                        $scope.{{ c.identifier }}.selected = {};
                    });
                });
        }

        //RECHERCHE DEFAULT
        var lasttimeout = false;
        $scope.$watch('{{ c.identifier }}.filter', function() {
            //on lance la recherche depuis le store
            if ($scope.{{ c.identifier }}.filter!={{ c.identifier }}Store.getFilters('default',true).global){
                if (lasttimeout){
                    $timeout.cancel(lasttimeout);
                    lasttimeout = false;
                }
                {{ c.identifier }}Store.setGlobalFilter($scope.{{ c.identifier }}.filter,'default');
                lasttimeout = $timeout(function () {
                    {{ c.identifier }}Store.getData(1,'default');
                },200);
            }
        });

        //FILTERS
        $scope.{{ c.identifier }}resetFilters = function (){
            $scope.{{ c.identifier }}.filterPanel = false;
            var opts = $scope.{{ c.identifier }}.filters;
            for ( var o in opts ) {
                $scope.{{ c.identifier }}.filters[o].value = '';
                delete $scope.{{ c.identifier }}.filters[o];
            }
            $scope.{{ c.identifier }}.filter='';
            {{ c.identifier }}Store.resetFilters('default');
            {{ c.identifier }}Store.getData(1,'default');
        }
        $scope.{{ c.identifier }}switchPanelFilters = function (){
            if ($scope.{{ c.identifier }}.filterPanel)
                $scope.{{ c.identifier }}.filterPanel = false;
            else
                $scope.{{ c.identifier }}.filterPanel = true;
        }
        $scope.{{ c.identifier }}applyFilters = function (){
            var opts = $scope.{{ c.identifier }}.filters,
                query = "";
            for ( var o in opts ) {
                if (query.length) query+='&';
                var value = opts[o].value;
                switch (value){
                    case true:
                        value = 1;
                        break;
                    case false:
                        value = 0;
                        break;
                }

                query+=o+((opts[o].operator==undefined)?'=':opts[o].operator)+value;
            }
            $scope.{{ c.identifier }}.filterQuery = '~'+$scope.{{ c.identifier }}.filter+'&'+query;
            console.log('controller >> list {{ c.identifier }} >> applyFilter ',query);
            {{ c.identifier }}Store.setOptionsFilters(query,'default');
            {{ c.identifier }}Store.getData(1,'default');
        }

        $scope.$watch('{{ c.identifier }}.pageLength', function() {
            console.log('pageLength',$scope.{{ c.identifier }}.pageLength);
            {{ c.identifier }}Store.setPageLength($scope.{{ c.identifier }}.pageLength,'default');
        });
        $scope.$watch('{{ c.identifier }}.currentPage', function() {
            {{ c.identifier }}Store.setPage($scope.{{ c.identifier }}.currentPage,'default');
        });
        $scope.{{ c.identifier }}setOptionsFilters = function (filter){
            {{ c.identifier }}Store.setOptionsFilters(filter,'default',false);
            {{ c.identifier }}Store.getData(1,'default');
        }
        $scope.{{ c.identifier }}add = function (){
            console.log('add {{ c.objecttype }}');
            $scope.modalObj = {{ c.identifier }}Store.getNewData();
            $scope.modalObj.success = false;
            $scope.modalObj.title = 'Ajouter un nouveau {{ c.description }}';
            $("#modal-{{ c.identifier }}").modal();
        }
        $scope.{{ c.identifier }}modify = function (obj){
            {{ c.identifier }}Store.getOneData(obj.id,'default',false).then(function (data) {
                $scope.modalObj = data;
                $scope.modalObj.success = false;
                $scope.modalObj.title = 'Modifier {{ c.description }} '+data.label;
                console.log('edit obj',$scope.modalObj);
            });
            $("#modal-{{ c.identifier }}").modal();
        }
        $scope.{{ c.identifier }}export = function (obj){
            {{ c.identifier }}Store.export('default');
        }
        $scope.{{ c.identifier }}modalSave = function (){
            $('#modal-{{ c.identifier }} .modal-dialog').spin();

            console.log('save ',$scope.modalObj);
            {{ c.identifier }}Store.saveData($scope.modalObj,'default').then(function (data) {
                $('#modal-{{ c.identifier }} .modal-dialog').spin(false);
                if (data.success){
                    $scope.modalObj = data.data;
                    $scope.modalObj.success = data.success;
                    $scope.modalObj.warning = data.warning;
                    $scope.modalObj.errors = data.errors;
                    $scope.modalObj.infos = data.infos;
                    if (!data.warning.length&&!data.success.length)
                        $("#modal-{{ c.identifier }}").modal('toggle');
                }else {
                    //gestion des erreurs
                    $scope.modalObj.errors = data.errors;
                    $scope.modalObj.warning = data.warning;
                    $scope.modalObj.infos = data.infos;
                    $scope.modalObj.fieldErrors = [];
                    for (var e in data.errors) {
                        $scope.modalObj.fieldErrors.push(data.errors[e].Prop);
                    }
                    console.log('tab field error',$scope.modalObj.fieldErrors);
                }
                console.log('save obj',data);
            });
        }
        $scope.{{ c.identifier }}delete = function (item){
            console.log('delete ',item);
            swal({
                    title: "Êtes vous sûr de vouloir supprimer "+item["label"]+"?",
                    text: "Cette suppression sera définitive. ",
                    type: "warning",
                    showCancelButton: true,
                    confirmButtonClass: "btn-danger",
                    cancelButtonText: "Annuler",
                    confirmButtonText: "Oui, supprimer !",
                    closeOnConfirm: true
                },
                function(){
                    {{ c.identifier }}Store.deleteOneData(item.id,'all');
                });
        }
        $scope.getSelectData = function (store,search){
            console.log('get select data',store,search);
            return $injector.get(store).getDataFilter(search,'form');
        }
        /*******
        * TREE
        *******/
        $scope.treeOptions = {
        };

        $scope.selectedItem = {};

        $scope.toggleChildren = function (scope) {
            console.log('toggle children');
            if (!scope.$nodeScope.$modelValue.children) {
                {{ c.identifier }}Store.loadRecursivChildren(scope.$nodeScope.$modelValue).then(function(data) {
                    scope.$nodeScope.$modelValue.children = data.children;
                    console.log('data load success',data);
                    if (scope.$nodeScope.$modelValue.children && scope.$nodeScope.$modelValue.children.length > 0) {
                        scope.$nodeScope.$modelValue.expanded = true;
                        scope.toggle();
                    }
                });
            } else {
                if (scope.$nodeScope.$modelValue.children.length > 0) {
                    scope.toggle();
                }
            }
        }

        /********
        * EXTENSION
        ********/

        var isExtended = false;
        if(typeof window['{{ c.name }}CtrlExtends'] == 'function') {
            isExtended = true;
        }
        try {
            $controller('{{ c.name }}CtrlExtends',{$scope: $rootScope.$new()});
            isExtended = true;
        } catch (error) {
            console.log('No extends',error);
        }
        if(isExtended)
            angular.extend(this, $controller('{{ c.name }}CtrlExtends', {$scope: $scope}));
    });

    /**** FICHE CONTROLLER ****/
    app.controller('{{ c.name }}FicheCtrl', function($controller,$injector,NgMap,$location, $scope,$timeout, $rootScope, $routeParams,$http,{{ c.identifier }}Store{% for parent in c.parentelements %},{{ parent.objectModule }}{{ parent.objectName }}Store{% endfor %}{% for child in c.childrenelements %},{{ child.objectModule }}{{ child.objectName }}Store {% for cParent in child.parentelements %},{{ cParent.objectModule }}{{ cParent.objectName }}Store{% endfor %}{% endfor %}{% if c.browseable%},SystemePageStore{% endif %}) {
        //acces aux stores parents
        {% for parent in c.parentelements %}
            var lasttimeoutParent{{ parent.objectModule }}{{ parent.objectName }} = false;
            {{ parent.objectModule }}{{ parent.objectName }}Store.setFilters('{{ parent.filter }}','parentselect');
            $scope.{{ parent.objectModule }}{{ parent.objectName }}Select = {
                data: {{ parent.objectModule }}{{ parent.objectName }}Store.data.parentselect,
                store: {{ parent.objectModule }}{{ parent.objectName }}Store,
                filter: '',
                currentPage: {{ parent.objectModule }}{{ parent.objectName }}Store.currentPage.parentselect,
                itemsPerPage: {{ parent.objectModule }}{{ parent.objectName }}Store.itemsPerPage,
                selected: {
                    selectall: false
                }
            }
            $scope.$watch('{{ parent.objectModule }}{{ parent.objectName }}Select.currentPage', function() {
                if ($scope.{{ parent.objectModule }}{{ parent.objectName }}Select.currentPage!={{ parent.objectModule }}{{ parent.objectName }}Store.getCurrentPage('parentselect')){
                    console.log('parentselect > {{ parent.objectModule }}{{ parent.objectName }} > changeCurrentPage > '+$scope.{{ parent.objectModule }}{{ parent.objectName }}Select.currentPage+' <> '+{{ parent.objectModule }}{{ parent.objectName }}Store.getCurrentPage('parentselect'));
                    {{ parent.objectModule }}{{ parent.objectName }}Store.setPage($scope.{{ parent.objectModule }}{{ parent.objectName }}Select.currentPage,'parentselect');
                }
            });
            $scope.$watch('{{ parent.objectModule }}{{ parent.objectName }}Select.filter', function() {
                //on lance la recherche depuis le store
                if ($scope.{{ parent.objectModule }}{{ parent.objectName }}Select.filter!={{ parent.objectModule }}{{ parent.objectName }}Store.getFilters('parentselect',true).global){
                    {{ parent.objectModule }}{{ parent.objectName }}Store.setFilters($scope.{{ parent.objectModule }}{{ parent.objectName }}Select.filter,'parentselect');
                    if (lasttimeoutParent{{ parent.objectModule }}{{ parent.objectName }}){
                        $timeout.cancel(lasttimeoutParent{{ parent.objectModule }}{{ parent.objectName }});
                        lasttimeoutParent{{ parent.objectModule }}{{ parent.objectName }} = false;
                    }
                    lasttimeoutParent{{ parent.objectModule }}{{ parent.objectName }}=$timeout(function () {
                        {{ parent.objectModule }}{{ parent.objectName }}Store.getData(1,'parentselect');
                    },200);
                }
            });
        {% endfor %}
        //récupération des données du store.
        {{ c.identifier }}Store.getOneData($routeParams.id,'fiche',true).then(function (data){
            $scope.obj = data;

            $scope.callFunction = function (obj,name,title,type){
                console.log('callfunction ',obj.id,title,type);
                $('#modalfunction-{{ c.identifier }} .modal-dialog').spin();
                switch (type){
                    case 'form':
                        var controls = {
                            save: true,
                            cancel: true,
                            close: false
                        };
                    break;
                    default:
                        var controls = {
                            save: false,
                            cancel: false,
                            close: true
                        };
                    break;
                }
                $scope.function = {
                    title: title,
                    loaded: false,
                    name: name,
                    controls: controls,
                    obj: obj,
                    url: '/{{ c.module }}/{{ c.objecttype }}/'+obj.id+'/'+name+'.htm?rand='+new Date().getTime()
                };
                $scope.$watch('function.loaded',function () {
                    if ($scope.function.loaded){
                        {{ c.identifier }}Store.getOneData(obj.id, false).then(function(data) {
                            $('#modalfunction-{{ c.identifier }}  .modal-dialog').spin(false);
                            $scope.modalObj = data;
                            console.log('function ' + title + ' obj', $scope.modalObj);
                        });
                    }
                });
                $("#modalfunction-{{ c.identifier }}").modal();
            }
            $scope.callFunctionSave = function (fu){
                console.log('callfunction save',fu);
                $('#modalfunction-{{ c.identifier }} .modal-dialog').spin();
                $http.post(fu.url,fu.fields)
                    .success(function(data) {
                        $('#modalfunction-{{ c.identifier }}  .modal-dialog').spin(false);
                        $scope.function.loaded = !data.success;
                        $scope.function.success = data.success;
                        $scope.function.controls = data.controls;
                        $scope.function.errors = data.errors;
                        $scope.function.message = data.message;
                        console.log('savefunction > '+fu.title, data);
                    });
            }
            $scope.modify = function (obj){
                console.log('edit ',obj.id);
                {{ c.identifier }}Store.getOneData(obj.id,'fiche',false).then(function (data) {
                    data.success = false;
                    $scope.obj = $scope.modalObj = data;
                    $scope.modalObj.title = 'Modifier {{ c.description }} '+data.label;
                    console.log('edit obj',$scope.modalObj);
                });
                $("#modalfiche-{{ c.identifier }}").modal();
            }
            $scope.modalSave = function (){
                console.log('save ',$scope.modalObj);
                //affichage spinner
                $('#modalfiche-{{ c.identifier }} .modal-dialog').spin();
                {{ c.identifier }}Store.saveData($scope.modalObj).then(function (data) {
                    $('#modalfiche-{{ c.identifier }} .modal-dialog').spin(false);
                    if (data.success){
                        $scope.modalObj = data.data;
                        $scope.modalObj.success = data.success;
                        $scope.modalObj.warning = data.warning;
                        $scope.modalObj.errors = data.errors;
                        $scope.modalObj.infos = data.infos;
                        $scope.modalObj = $scope.obj
                        if (!data.warning.length&&!data.success.length)
                            $("#modalfiche-{{ c.identifier }}").modal('toggle');
                        {{ c.identifier }}Store.refresh();
                    }else {
                        //gestion des erreurs
                        $scope.modalObj.errors = data.errors;
                        $scope.modalObj.success = data.success;
                        $scope.modalObj.warning = data.warning;
                        $scope.modalObj.errors = data.errors;
                        $scope.modalObj.infos = data.infos;
                        $scope.modalObj.fieldErrors = [];
                        for (var e in data.errors) {
                            $scope.modalObj.fieldErrors.push(data.errors[e].Prop);
                        }
                        console.log('tab field error',$scope.modalObj.fieldErrors);
                    }
                    console.log('save obj',data);
                });
            }
            $scope.delete = function (item){
                console.log('edit ',item);
                swal({
                        title: "Êtes vous sûr de vouloir supprimer "+item["label"]+"?",
                        text: "Cette suppression sera définitive. ",
                        type: "warning",
                        showCancelButton: true,
                        confirmButtonClass: "btn-danger",
                        cancelButtonText: "Annuler",
                        confirmButtonText: "Oui, supprimer !",
                        closeOnConfirm: true
                    },
                    function(){
                        {{ c.identifier }}Store.deleteOneData(item.id,'all');
                        $location.path('{{ c.url }}');
                    });
            }
            {% for child in c.childrenelements %}


                //FORMULAIRE CHILDREN
                $scope.{{ child.objectModule }}{{ child.objectName }} = {
                    data : {{ child.objectModule }}{{ child.objectName }}Store.data.children,
                    store: {{ child.objectModule }}{{ child.objectName }}Store,
                    filter: '',
                    pageLength: {{ child.objectModule }}{{ child.objectName }}Store.getPageLength(),
                    currentPage: {{ child.objectModule }}{{ child.objectName }}Store.currentPage.children,
                    itemsPerPage: {{ child.objectModule }}{{ child.objectName }}Store.itemsPerPage,
                    selected: {
                        selectall: false
                    }
                }

                //FORMULAIRE SELECT
                $scope.{{ child.objectModule }}{{ child.objectName }}Select = {
                    data : {{ child.objectModule }}{{ child.objectName }}Store.data.select,
                    store: {{ child.objectModule }}{{ child.objectName }}Store,
                    filter: '',
                    pageLength: {{ child.objectModule }}{{ child.objectName }}Store.getPageLength(),
                    currentPage: {{ child.objectModule }}{{ child.objectName }}Store.currentPage.select,
                    itemsPerPage: {{ child.objectModule }}{{ child.objectName }}Store.itemsPerPage,
                    selected: {
                        selectall: false
                    }
                }

                //RECHERCHE SELECT
                var lasttimeoutSelect{{ child.objectModule }}{{ child.objectName }} = false;
                $scope.$watch('{{ child.objectModule }}{{ child.objectName }}Select.filter', function() {
                    //on lance la recherche depuis le store
                    if ($scope.{{ child.objectModule }}{{ child.objectName }}Select.filter!={{ child.objectModule }}{{ child.objectName }}Store.getFilters('select',true).global){
                        {{ child.objectModule }}{{ child.objectName }}Store.setFilters($scope.{{ child.objectModule }}{{ child.objectName }}Select.filter,'select');
                        if (lasttimeoutSelect{{ child.objectModule }}{{ child.objectName }}){
                            $timeout.cancel(lasttimeoutSelect{{ child.objectModule }}{{ child.objectName }});
                            lasttimeoutSelect{{ child.objectModule }}{{ child.objectName }} = false;
                        }
                        lasttimeoutSelect{{ child.objectModule }}{{ child.objectName }} = $timeout(function () {
                            {{ child.objectModule }}{{ child.objectName }}Store.getData(1,'select');
                        },200);
                    }
                });

                //PAGINATION SELECT
                $scope.$watch('{{ child.objectModule }}{{ child.objectName }}Select.currentPage', function() {
                    if ($scope.{{ child.objectModule }}{{ child.objectName }}Select.currentPage!={{ child.objectModule }}{{ child.objectName }}Store.getCurrentPage('select')){
                        console.log('select > {{ child.objectModule }}{{ child.objectName }} > changeCurrentPage > '+$scope.{{ child.objectModule }}{{ child.objectName }}Select.currentPage+' <> '+{{ child.objectModule }}{{ child.objectName }}Store.getCurrentPage('select'));
                        {{ child.objectModule }}{{ child.objectName }}Store.setPage($scope.{{ child.objectModule }}{{ child.objectName }}Select.currentPage,'select');
                    }
                });

                //SELECTION
                $scope.$watch('{{ child.objectModule }}{{ child.objectName }}.selected.selectall', function() {
                    if ($scope.{{ child.objectModule }}{{ child.objectName }}.selected.selectall){
                        var data = {{ child.objectModule }}{{ child.objectName }}Store.data.children;
                        console.log('tous le store',data);
                        for (var i in data) {
                            $scope.{{ child.objectModule }}{{ child.objectName }}.selected[data[i].id] = true;
                        }
                    }else{
                        $scope.{{ child.objectModule }}{{ child.objectName }}.selected = {selectall:false};
                    }
                });

                //CALL FUNCTION
                $scope.{{ child.objectModule }}{{ child.objectName }}callFunction = function (obj,name,title){
                    console.log('callfunction ',obj.id,title);
                    $('#modalfunction-{{ child.objectModule }}{{ child.objectName }} .modal-dialog').spin();

                    $scope.{{ child.objectModule }}{{ child.objectName }}function = {
                        title: title,
                        loaded: false,
                        name: name,
                        url: '/{{ child.objectModule }}/{{ child.objectName }}/'+obj.id+'/'+name+'.htm?rand='+new Date().getTime()
                    };

                    {{ child.objectModule }}{{ child.objectName }}Store.getOneData(obj.id,false).then(function (data) {
                        $scope.modalObj = data;
                        console.log('function '+title+' obj',$scope.modalObj);
                        $('#modalfunction-{{ child.objectModule }}{{ child.objectName }} .modal-dialog').spin(false);
                    });

                    $("#modalfunction-{{ child.objectModule }}{{ child.objectName }}").modal();
                }

                //MASS DELETE
                $scope.{{ child.objectModule }}{{ child.objectName }}selectDelete = function () {
                    //nettoyage de la selection
                    var sel= [];
                    for (var i in $scope.{{ child.objectModule }}{{ child.objectName }}.selected){
                        if ($scope.{{ child.objectModule }}{{ child.objectName }}.selected[i]&&parseInt(i)>0)sel.push(i);
                    }
                    console.log('Suppression de la sélection ',sel);
                    swal({
                            title: "Êtes vous sûr de vouloir supprimer les "+sel.length+" éléments ?",
                            text: "Cette suppression sera définitive. ",
                            type: "warning",
                            showCancelButton: true,
                            confirmButtonClass: "btn-danger",
                            cancelButtonText: "Annuler",
                            confirmButtonText: "Oui, supprimer !",
                            closeOnConfirm: true
                        },
                        function(){
                            $http.post('/{{ child.objectModule }}/{{ child.objectName }}/massDelete.json',sel)
                            .success(function(data) {
                                console.log('store > {{ child.objectModule }} {{ child.objectName }} > deleted ', data);
                                {{ child.objectModule }}{{ child.objectName }}Store.refresh('children');
                                $scope.{{ child.objectModule }}{{ child.objectName }}selected = {};
                        });
                    });
                }

                //RECHERCHE CHILDREN
                var lasttimeout{{ child.objectModule }}{{ child.objectName }} = false;
                $scope.$watch('{{ child.objectModule }}{{ child.objectName }}.filter', function() {
                    //on lance la recherche depuis le store
                    if ($scope.{{ child.objectModule }}{{ child.objectName }}.filter!={{ child.objectModule }}{{ child.objectName }}Store.getFilters('children',true)){
                        {{ child.objectModule }}{{ child.objectName }}Store.setFilters($scope.{{ child.objectModule }}{{ child.objectName }}.filter,'children');
                        if (lasttimeout{{ child.objectModule }}{{ child.objectName }}){
                            $timeout.cancel(lasttimeoutSelect{{ child.objectModule }}{{ child.objectName }});
                            lasttimeout{{ child.objectModule }}{{ child.objectName }} = false;
                        }
                        lasttimeout{{ child.objectModule }}{{ child.objectName }}=$timeout(function () {
                            {{ child.objectModule }}{{ child.objectName }}Store.getData(1,'children');
                        },200);
                    }
                });

                //PAGINATION CHILDREN
                $scope.$watch('{{ child.objectModule }}{{ child.objectName }}.currentPage', function() {
                    if ($scope.{{ child.objectModule }}{{ child.objectName }}.currentPage!={{ child.objectModule }}{{ child.objectName }}Store.getCurrentPage('children')){
                        {{ child.objectModule }}{{ child.objectName }}Store.setPage($scope.{{ child.objectModule }}{{ child.objectName }}.currentPage,'children');
                    }
                });

                //ADD
                $scope.{{ child.objectModule }}{{ child.objectName }}add = function (){
                    console.log('child add {{ child.objectName }}');
                    $scope.modalObj = {{ child.objectModule }}{{ child.objectName }}Store.getNewData();
                    $scope.modalObj.success = false;
                    $scope.modalObj.{{ c.objecttype }}{{ child.name }} = $scope.obj.id;
                    $scope.modalObj.{{ c.objecttype }}{{ child.name }}label = $scope.obj.label;
                    $scope.modalObj.title = 'Ajouter un nouveau {{ child.objectDescription }}';
                    $("#modal-{{ child.objectModule }}{{ child.objectName }}").modal();
                }

                //MODIFY
                $scope.{{ child.objectModule }}{{ child.objectName }}modify = function (obj){
                    console.log('edit ',obj.id);
                    {{ child.objectModule }}{{ child.objectName }}Store.getOneData(obj.id,'children',false).then(function (data) {
                        $scope.modalObj = data;
                        $scope.modalObj.success = false;
                        $scope.modalObj.{{ c.objecttype }}{{ child.name }} = $scope.obj.id;
                        $scope.modalObj.{{ c.objecttype }}{{ child.name }}label = $scope.obj.label;
                        $scope.modalObj.title = 'Modifier {{ child.objectDescription }} '+data.label;
                        console.log('edit obj',$scope.modalObj);
                    });
                    $("#modal-{{ child.objectModule }}{{ child.objectName }}").modal();
                }

                //EXPORT
                $scope.{{ child.objectModule }}{{ child.objectName }}export = function (obj){
                    console.log('export {{ child.objectModule }}{{ child.objectName }}');
                    {{ child.objectModule }}{{ child.objectName }}Store.export('children');
                }

                //MODALSAVE
                $scope.{{ child.objectModule }}{{ child.objectName }}modalSave = function (){
                    console.log('children > save {{ child.objectModule }}{{ child.objectName }}',$scope.modalObj);
                    $('#modal-{{ child.objectModule }}{{ child.objectName }} .modal-dialog').spin();

                    {{ child.objectModule }}{{ child.objectName }}Store.saveData($scope.modalObj).then(function (data) {
                        $('#modal-{{ child.objectModule }}{{ child.objectName }} .modal-dialog').spin(false);
                        if (data.success){
                            $scope.modalObj = data.data;
                            $scope.modalObj.errors = data.errors;
                            $scope.modalObj.success = data.success;
                            $scope.modalObj.warning = data.warning;
                            $scope.modalObj.errors = data.errors;
                            $scope.modalObj.infos = data.infos;
                            if (!data.warning.length&&!data.success.length)
                                $("#modal-{{ child.objectModule }}{{ child.objectName }}").modal('toggle');
                            {{ child.objectModule }}{{ child.objectName }}Store.refresh('children');
                        }else {
                            //gestion des erreurs
                            $scope.modalObj.errors = data.errors;
                            $scope.modalObj.success = data.success;
                            $scope.modalObj.warning = data.warning;
                            $scope.modalObj.errors = data.errors;
                            $scope.modalObj.infos = data.infos;
                            $scope.modalObj.fieldErrors = [];
                            for (var e in data.errors) {
                                $scope.modalObj.fieldErrors.push(data.errors[e].Prop);
                            }
                            console.log('tab field error',$scope.modalObj.fieldErrors);
                        }
                        console.log('save obj {{ child.objectModule }}{{ child.objectName }}',data);
                    });
                }

                //GETSELECTDATA
                $scope.getSelectData = function (store,search){
                    console.log('get select data',store,search);
                    return $injector.get(store).getDataFilter(search,'form');
                }

                //DELETE
                $scope.{{ child.objectModule }}{{ child.objectName }}delete = function (item){
                    console.log('delete ',item);
                    swal({
                            title: "Êtes vous sûr de vouloir supprimer {{ child.objectDescription }} "+item["label"]+"?",
                            text: "Cette suppression sera définitive. ",
                            type: "warning",
                            showCancelButton: true,
                            confirmButtonClass: "btn-danger",
                            cancelButtonText: "Annuler",
                            confirmButtonText: "Oui, supprimer !",
                            closeOnConfirm: true
                        },
                        function(){
                            {{ child.objectModule }}{{ child.objectName }}Store.deleteOneData(item.id,'all');
                    });
                }
                /*******
                * TREE
                *******/
                $scope.treeOptions = {
                };

                $scope.selectedItem = {};

                $scope.toggleChildren = function (scope) {
                    console.log('toggle children');
                    if (!scope.$nodeScope.$modelValue.children) {
                        {{ c.identifier }}Store.loadRecursivChildren(scope.$nodeScope.$modelValue).then(function(data) {
                            scope.$nodeScope.$modelValue.children = data.children;
                            console.log('data load success',data);
                            if (scope.$nodeScope.$modelValue.children && scope.$nodeScope.$modelValue.children.length > 0) {
                                scope.$nodeScope.$modelValue.expanded = true;
                                scope.toggle();
                            }
                        });
                    } else {
                        if (scope.$nodeScope.$modelValue.children.length > 0) {
                            scope.toggle();
                        }
                    }
                }

                {% for cParent in child.parentelements %}
                    var lasttimeoutCParent{{ cParent.objectModule }}{{ cParent.objectName }} = false;

                    {{ cParent.objectModule }}{{ cParent.objectName }}Store.setFilters('{{ cParent.filter }}','cparentselect');

                    $scope.{{ cParent.objectModule }}{{ cParent.objectName }}CPSelect = {
                        data: {{ cParent.objectModule }}{{ cParent.objectName }}Store.data.cparentselect,
                        store: {{ cParent.objectModule }}{{ cParent.objectName }}Store,
                        filter: {{ cParent.objectModule }}{{ cParent.objectName }}Store.filter.cparentselect,
                        currentPage: {{ cParent.objectModule }}{{ cParent.objectName }}Store.currentPage.cparentselect,
                        itemsPerPage: {{ cParent.objectModule }}{{ cParent.objectName }}Store.itemsPerPage,
                        selected: {
                            selectall: false
                        }
                    }
                    $scope.$watch('{{ cParent.objectModule }}{{ cParent.objectName }}CPSelect.currentPage', function() {
                        if ($scope.{{ cParent.objectModule }}{{ cParent.objectName }}CPSelect.currentPage!={{ cParent.objectModule }}{{ cParent.objectName }}Store.getCurrentPage('cparentselect')){
                            console.log('cparentselect > {{ cParent.objectModule }}{{ cParent.objectName }} > changeCurrentPage > '+$scope.{{ cParent.objectModule }}{{ cParent.objectName }}CPSelect.currentPage+' <> '+{{ cParent.objectModule }}{{ cParent.objectName }}Store.getCurrentPage('cparentselect'));
                            {{ cParent.objectModule }}{{ cParent.objectName }}Store.setPage($scope.{{ cParent.objectModule }}{{ cParent.objectName }}CPSelect.currentPage,'cparentselect');
                        }
                    });
                    $scope.$watch('{{ cParent.objectModule }}{{ cParent.objectName }}CPSelect.filter', function() {
                        //on lance la recherche depuis le store
                        if ($scope.{{ cParent.objectModule }}{{ cParent.objectName }}CPSelect.filter!={{ cParent.objectModule }}{{ cParent.objectName }}Store.getFilters('cparentselect',true)){
                            {{ cParent.objectModule }}{{ cParent.objectName }}Store.setFilters($scope.{{ cParent.objectModule }}{{ cParent.objectName }}CPSelect.filter,'cparentselect');
                            if (lasttimeoutCParent{{ cParent.objectModule }}{{ cParent.objectName }}){
                                $timeout.cancel(lasttimeoutCParent{{ cParent.objectModule }}{{ cParent.objectName }});
                                lasttimeoutCParent{{ cParent.objectModule }}{{ cParent.objectName }} = false;
                            }
                            lasttimeoutCParent{{ cParent.objectModule }}{{ cParent.objectName }}=$timeout(function () {
                                {{ cParent.objectModule }}{{ cParent.objectName }}Store.getData(1,'cparentselect');
                            },200);
                        }
                    });
                {% endfor %}

            {% endfor %}

            //gestion des widget
            {% for i in c.Interfaces %}
                {% for w in i %}
                    {% if w.type == 'GeolocIP' %}
                        console.log('>>>> interface {{ w.type }}');
                        NgMap.getMap().then(function(map) {
                            //géolocalisation d'une ip
                            $http({
                                method: 'GET',
                                url: 'https://freegeoip.net/json/'+$scope.obj.{{ w.field }}
                            }).then(function successCallback(response) {
                                console.log('GEOLOCIP > response ',response,'http://freegeoip.net/json/'+$scope.obj.{{ w.field }});
                                //clearMarker
                                if (map.markers)
                                    for (var i=0; i< map.markers.length;i++) {
                                        map.markers[i].setMap(null);
                                    }
                                else map.markers = [];
                                //setcenter
                                map.setCenter(new google.maps.LatLng(response.data.latitude, response.data.longitude));
                                //add marker
                                var marker = new google.maps.Marker({
                                    position: new google.maps.LatLng(response.data.latitude, response.data.longitude),
                                    map: map,
                                    title: $scope.obj.label
                                });
                                map.markers.push(marker);
                            }, function errorCallback(response) {
                                console.log('GEOLOCIP > error ',response);
                            });
                        });
                    {% endif %}
                {% endfor %}
            {% endfor %}

            $scope.show = true;


            //gestion des pages
            {% if c.browseable%}
                var lasttimeoutSystemePage = false;
                SystemePageStore.setFilters('PageModule={{ c.module }}&PageObject={{ c.objecttype }}&PageId='+$scope.obj.id,'SystemePage{{ c.identifier }}');
                $scope.SystemePage = {
                    data: SystemePageStore.data.SystemePage{{ c.identifier }},
                    store: SystemePageStore,
                    filter: 'PageModule={{ c.module }}&PageObject={{ c.objecttype }}&PageId='+$scope.obj.id,
                    currentPage: SystemePageStore.currentPage.SystemePage{{ c.identifier }},
                    itemsPerPage: SystemePageStore.itemsPerPage,
                    selected: {
                        selectall: false
                    }
                }


                $scope.$watch('SystemePage.currentPage', function() {
                    if ($scope.SystemePage.currentPage!=SystemePageStore.getCurrentPage('SystemePage{{ c.identifier }}')){
                        console.log('SystemePage{{ c.identifier }} > SystemePage > changeCurrentPage > '+$scope.SystemePage.currentPage+' <> '+SystemePageStore.getCurrentPage('SystemePage{{ c.identifier }}'));
                        SystemePageStore.setPage($scope.SystemePage.currentPage,'SystemePage{{ c.identifier }}');
                    }
                });
                $scope.$watch('SystemePage.filter', function() {
                    //on lance la recherche depuis le store
                    if ($scope.SystemePage.filter!=SystemePageStore.getFilters('SystemePage{{ c.identifier }}',true).global){
                        SystemePageStore.setFilters($scope.SystemePage.filter,'SystemePage{{ c.identifier }}');
                        if (lasttimeoutSystemePage){
                            $timeout.cancel(lasttimeoutSystemePage);
                            lasttimeoutSystemePage = false;
                        }
                        lasttimeoutSystemePage=$timeout(function () {
                            SystemePageStore.getData(1,'SystemePage{{ c.identifier }}');
                        },200);
                    }
                });


                //MODIFY
                $scope.SystemePagemodify = function (obj){
                    console.log('edit ',obj.id);
                    SystemePageStore.getOneData(obj.id,'SystemePage{{ c.identifier }}',false).then(function (data) {
                        $scope.pageObj = data;
                        $scope.pageObj.success = false;
                        $scope.pageObj.SystemePage = $scope.obj.id;
                        $scope.pageObj.SystemePagelabel = $scope.obj.label;
                        $scope.pageObj.title = 'Modifier Page Systeme '+data.label;
                        console.log('edit obj',$scope.pageObj);
                    });
                    $("#modal-SystemePage").modal();
                }


                //MODALSAVE
                $scope.SystemePagemodalSave = function (){
                    console.log('children > save SystemePage',$scope.pageObj);
                    $('#modal-SystemePage .modal-dialog').spin();

                    SystemePageStore.saveData($scope.pageObj).then(function (data) {
                        $('#modal-SystemePage .modal-dialog').spin(false);
                        if (data.success){
                            $scope.pageObj = data.data;
                            $scope.pageObj.errors = data.errors;
                            $scope.pageObj.success = data.success;
                            $scope.pageObj.warning = data.warning;
                            $scope.pageObj.errors = data.errors;
                            $scope.pageObj.infos = data.infos;
                            if (!data.warning.length&&!data.success.length)
                                $("#modal-SystemePage").modal('toggle');
                            SystemePageStore.refresh('SystemePage{{ c.identifier }}');
                        }else {
                            //gestion des erreurs
                            $scope.pageObj.errors = data.errors;
                            $scope.pageObj.success = data.success;
                            $scope.pageObj.warning = data.warning;
                            $scope.pageObj.errors = data.errors;
                            $scope.pageObj.infos = data.infos;
                            $scope.pageObj.fieldErrors = [];
                            for (var e in data.errors) {
                                $scope.pageObj.fieldErrors.push(data.errors[e].Prop);
                            }
                            console.log('tab field error',$scope.pageObj.fieldErrors);
                        }
                    console.log('save obj SystemePage',data);
                    });
                }

            {% endif %}

            var isExtended = false;
            if(typeof window['{{ c.name }}FicheCtrlExtends'] == 'function') {
                isExtended = true;
            }
            try {
                $controller('{{ c.name }}FicheCtrlExtends',{$scope: $rootScope.$new()});
                isExtended = true;
            } catch (error) {
                console.log('No extends',error);
            }
            if(isExtended)
                angular.extend(this, $controller('{{ c.name }}FicheCtrlExtends', {$scope: $scope}));
        });
        });
    {% endif %}
{% endfor %}
