[OBJ [!Module::Actuel::Nom!]|[!lastObject!]|Objet]
//On ajoute une liaison sur l emplacement si il s agit d un nouvel objet
[METHOD Objet|AddParent]
	[PARAM][!Query!][/PARAM]
[/METHOD]
//Creation de l'objet
[COUNT [!Objet::Proprietes!]|C]

[IF [!C!]>1]
    [INFO [!Query!]|Parent]
    [!Integrated:=False!]
    [STORPROC [!Objet::typesParent!]|Par]
	[IF [!Par::Titre!]==[!Parent::ObjectType!]&&[!Par::Behaviour!]==Integrated]
	    [!Integrated:=True!]
	[/IF]
    [/STORPROC]
    [IF [!Integrated!]==True]
	[STORPROC [!Query!]|HistoObj|0|1]
	    [STORPROC [!HistoObj::Historique!]|Histo|0|1]
		[MODULE [!HistoObj::Module!]/[!Histo::ObjectType!]/[!Histo::Id!]]
		[!BackUrl:=[!HistoObj::Module!]/[!Histo::ObjectType!]/[!Histo::Id!]!]
	    [/STORPROC]
	[/STORPROC]
	[IF [!detail!]="Valider"]
	    //Alors on enregistre les proprietes
	    [STORPROC [!CONF::GENERAL::LANGUAGE!]|Lang]
		[STORPROC [!Objet::Proprietes([!Key!])!]|Prop]
		    [METHOD Objet|Set]
			[PARAM][!Prop::Nom!][/PARAM]
			[PARAM][!Form_[!Prop::Nom!]!][/PARAM]
		    [/METHOD]
		[/STORPROC]
	    [/STORPROC]
	    //Sauvegarde l objet
	    [IF [!Objet::Verify!]]
		[METHOD Objet|Save][/METHOD]
		//[REDIRECT][!BackUrl!][/REDIRECT]
	    [ELSE]
		<ul class="Error">
		    <li><h1>Erreur d'enregistrement [!Objet::ObjectType!]</h1></li>
		    [STORPROC [!Objet::Error!]|E]
			<li>[!E::Message!]</li>
			//Generation d une variable d error pour informer le champ en question
			[!C_[!E::Prop!]Cv_Error:=1!]
		    [/STORPROC]
		</ul>		
	    [/IF]
	[ELSE]
	    [BLOC PopUpForm|AJOUTER|Larger|[!BackUrl!]]
	    //[MODULE Systeme/Interfaces/Formulaire/ModifProprietes?Prop=[!Prop!]]	
	    [MODULE Systeme/Interfaces/Formulaire?Objet=[!Objet!]&Action=Ajouter&Type=PopUp]
	    [/BLOC]
	[/IF]
    [ELSE]
	[BLOC Panneau|||overflow:auto;]
		[MODULE Systeme/Interfaces/Formulaire?Objet=[!Objet!]&Action=Ajouter]
	[/BLOC]
    [/IF]
[ELSE]
	<form enctype="multipart/form-data" action="" method="post" name="frm" >
	[STORPROC [!Objet::Proprietes!]|Prop]
		[SWITCH [!Prop::Type!]|=]
			[CASE ObjectClass]
				[IF [!Form_[!Prop::Nom!]_New!]!=]
					[!Form_[!Prop::Nom!]==[!Form_[!Prop::Nom!]_New!]!]
					[!Form_[!Prop::Nom!]_explore==New!]
					[TITLE][!Form_[!Prop::Nom!]!][/TITLE]
				[/IF]
				[IF [!Form_[!Prop::Nom!]_explore!]=OK||[!Form_[!Prop::Nom!]_explore!]=]
					[MODULE Systeme/Interfaces/Explorer?Prop=[!Prop!]&Alone=1]
				[ELSE]
					[IF [!Form_[!Prop::Nom!]_explore!]=Fermer]
						[COUNT [!Form_[!Prop::Nom!]_Multi!]|T]
						[IF [!T!]>0]
							[STORPROC [!Form_[!Prop::Nom!]_Multi!]|Te]
								[OBJ [!Module::Actuel::Nom!]|[!lastObject!]|Objet]
								//Enregistrement
								[STORPROC [!Objet::Proprietes!]|Pr]
									[METHOD Objet|Set]
										[PARAM][!Pr::Nom!][/PARAM]
										[PARAM][!Te!][/PARAM]
									[/METHOD]
								[/STORPROC]
								[METHOD Objet|AddParent]
									[PARAM][!Query!][/PARAM]
								[/METHOD]
								[METHOD Objet|Save][/METHOD]
							[/STORPROC]
						[ELSE]
							//Enregistrement
							[STORPROC [!Objet::Proprietes!]|Pr]
								[METHOD Objet|Set]
									[PARAM][!Pr::Nom!][/PARAM]
									[PARAM][!Form_[!Prop::Nom!]!][/PARAM]
								[/METHOD]
							[/STORPROC]
							[METHOD Objet|Save][/METHOD]
						[/IF]
					[/IF]
				[/IF]
			[/CASE]
			[DEFAULT]
				//Selon le type de la proprietes on demande directement en popup la valeur
				[IF [!detail!]="Valider"]
					//Alors on enregistre les proprietes
					[STORPROC [!CONF::GENERAL::LANGUAGE!]|Lang]
						[STORPROC [!Objet::Proprietes([!Key!])!]|Prop]
							[METHOD Objet|Set]
								[PARAM][!Prop::Nom!][/PARAM]
								[PARAM][!Form_[!Prop::Nom!]!][/PARAM]
							[/METHOD]
						[/STORPROC]
					[/STORPROC]
					//Sauvegarde l objet
					[IF [!Objet::Verify!]]
						[METHOD Objet|Save][/METHOD]
						[REDIRECT][!Query!][/REDIRECT]
					[ELSE]
						<ul class="Error">
							<li><h1>Erreur d'enregistrement [!Objet::ObjectType!]</h1></li>
						[STORPROC [!Objet::Error!]|E]
							<li>[!E::Message!]</li>
							//Generation d une variable d error pour informer le champ en question
							[!C_[!E::Prop!]Cv_Error:=1!]
						[/STORPROC]
						</ul>		
					[/IF]
				[ELSE]
					[BLOC PopUpForm|AJOUTER]
						//[MODULE Systeme/Interfaces/Formulaire/ModifProprietes?Prop=[!Prop!]]	
						[MODULE Systeme/Interfaces/Formulaire?Objet=[!Objet!]&Action=Ajouter&Type=PopUp]
					[/BLOC]
				[/IF]
			[/DEFAULT]
		[/SWITCH]
	[/STORPROC]
	</form>
	[MODULE [!Query!]]
[/IF]

