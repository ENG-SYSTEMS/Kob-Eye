[INI memory_limit]80M[/INI]
[INI max_execution_time]7200[/INI]
//On genere l objet d envoi
[STORPROC Newsletter/Envoi/[!Env!]|En][/STORPROC]
//On compte le nombre de contact dans la liste a envoyer
[COUNT Newsletter/GroupeEnvoi/[!Form_GroupEnvoi!]/Contact/Actif=1|C]
//TOTAL -->> [!C!]
//On initiliase le message d erreur et le compteur
[!Erreur:=Les adresses suivantes comportent des erreurs :<br />!]
[!CptErr:=0!]
//On regarde si il s'agit d'une reprise
[!Boucle:=[!C:/100!]!]
[!Boucle:=[!Math::Floor([!Boucle!])!]!]
[!Boucle+=1!]
[IF [!En::Progression!]>0]
	//Calcul du lot de dÃ©part
	[!Pd:=[!Boucle:*[!En::Progression:/100!]!]!]
	[!Pd:=[!Math::Floor([!Pd!])!]!]
	//On reinitialise le compteur
	[!Compte:=[!Math::Floor([!Pd:*100!])!]!]
[ELSE]
	[!Pd:=0!]
	//On reinitialise le compteur
	[!Compte:=0!]
[/IF]
[!Pl:=[!Boucle:-[!Pd!]!]!]
//T -->> [!Boucle!]|P|[!Pd!]|[!Pl!]
//On verifi que l'envoi n'est pas deja en cours
[IF [!En::Busy!]=0]
	//[METHOD En|Set][PARAM]Busy[/PARAM][PARAM]1[/PARAM][/METHOD]
	[!En::Save()!]
	[STORPROC [!Boucle!]|P|[!Pd!]|[!Pl!]]
		//<li>-----------------[!P!]------------------</li>
		[STORPROC Newsletter/GroupeEnvoi/[!Form_GroupEnvoi!]/Contact/Actif=1|Con|[!Math::Floor([!P:*100!])!]|100|Id|ASC]
			[!Compte+=1!]
			[!NbContact:=[!NbResult!]!]
			[LIB PHPMailer|M]
			//[IF [!M::ValidEmail([!Con::Email!])!]]
				[METHOD M|Set][PARAM]CharSet[/PARAM][PARAM]utf-8[/PARAM][/METHOD]
				[METHOD M|AddAddress][PARAM][!Con::Email!][/PARAM][PARAM][!Con::Nom!] [!Con::Prenom!][/PARAM][/METHOD]
				[METHOD M|Set][PARAM]Subject[/PARAM][PARAM][!En::Sujet!][/PARAM][/METHOD]
				[METHOD M|SetFrom][PARAM][!CONF::GENERAL::INFO::ADMIN_MAIL!][/PARAM][PARAM][!CONF::GENERAL::INFO::ADMIN_MAIL!][/PARAM][/METHOD]
				[METHOD M|AddReplyTo][PARAM][!CONF::GENERAL::INFO::ADMIN_MAIL!][/PARAM][PARAM][!CONF::GENERAL::INFO::ADMIN_MAIL!][/PARAM][/METHOD]
				[METHOD M|MsgHTML]
					[PARAM]
						[!En::Contenu!]
						[MODULE Newsletter/Lettre/Desabonner?Con=[!Con!]]
					[/PARAM]
				[/METHOD]
				[METHOD M|Set][PARAM]AltBody[/PARAM]
					[PARAM]
						Veuillez afficher le mail en version html.
						[MODULE Newsletter/Lettre/Desabonner?Con=[!Con!]]
					[/PARAM]
				[/METHOD]
				//<li>[!Compte!] - [!Con::Email!]</li>
				[METHOD M|Send][/METHOD]
			//[ELSE]
			//	[!Erreur+= - [!Con::Email!]<br />!]
			//	[!CptErr+=1!]
			//[/IF]
			//Mise a jour du compte pour le chargement
			//Stockage dans l objet d envoi
			[COOKIE Reset|Prog]
			[COOKIE Set|Progression|Prog]
		[/STORPROC]
		//[METHOD En|Set][PARAM]Progression[/PARAM][PARAM][![!Compte:/[!C!]!]:*100!][/PARAM][/METHOD]
		[METHOD En|Save][/METHOD]
	[/STORPROC]
	[IF [!CptErr!]!=0]
		[METHOD En|Set][PARAM]Erreurs[/PARAM][PARAM][!Erreur!][/PARAM][/METHOD]
	[ELSE]
		[METHOD En|Set][PARAM]Erreurs[/PARAM][PARAM]Aucunes erreurs[/PARAM][/METHOD]
	[/IF]
	[METHOD En|Set][PARAM]Busy[/PARAM][PARAM]0[/PARAM][/METHOD]
	[METHOD En|Save][/METHOD]
[ELSE]
	ENVOI [!En::Id!] DEJA EN COURS
[/IF]
